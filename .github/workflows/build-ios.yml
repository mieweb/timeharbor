name: Build iOS App

on:
  push:
    branches: [ ios-app-development ]
  pull_request:
    branches: [ ios-app-development ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install Meteor
      run: |
        curl https://install.meteor.com/ | sh
        export PATH="$HOME/.meteor:$PATH"
        echo "$HOME/.meteor" >> $GITHUB_PATH
        
    - name: Install dependencies
      run: |
        npm install
        meteor npm install
        
    - name: Add iOS platform
      run: |
        meteor add-platform ios || echo "iOS platform already exists or failed to add"
        
    - name: Verify iOS platform
      run: |
        echo "Checking iOS platform..."
        ls -la .meteor/
        cat .meteor/platforms || echo "No platforms file found"
        
    - name: Build iOS app
      run: |
        echo "Building iOS app..."
        meteor build ./build --server=https://timeharbor.com
        
    - name: Verify build output
      run: |
        echo "Checking build output..."
        ls -la build/
        ls -la build/ios/ || echo "No iOS build found"
        ls -la build/ios/project/ || echo "No iOS project found"
        
    - name: Upload iOS build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-build
        path: |
          build/ios/
        retention-days: 30
        
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs
        path: |
          build/
        retention-days: 7
